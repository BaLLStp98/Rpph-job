<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Register Department</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Test Register Department</h1>
    
    <div class="test-section">
        <h2>Test 1: Check ResumeDeposit API</h2>
        <button onclick="testResumeDepositAPI()">Test ResumeDeposit API</button>
        <div id="result1" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Simulate register?department</h2>
        <p>This simulates what happens when someone visits register?department=IT</p>
        <button onclick="simulateRegisterDepartment()">Simulate register?department=IT</button>
        <div id="result2" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Check specific email</h2>
        <input type="email" id="testEmail" placeholder="Enter email to test" value="test@example.com">
        <button onclick="testSpecificEmail()">Test Specific Email</button>
        <div id="result3" class="result"></div>
    </div>

    <script>
        async function testResumeDepositAPI() {
            try {
                console.log('üîç Testing ResumeDeposit API...');
                const response = await fetch('/api/resume-deposit');
                const data = await response.json();
                
                console.log('API Response:', data);
                
                document.getElementById('result1').innerHTML = `
                    <h3>API Status: ${response.status}</h3>
                    <p>Total records: ${data.data ? data.data.length : 0}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result1').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        async function simulateRegisterDepartment() {
            try {
                console.log('üîç Simulating register?department=IT...');
                
                // Mock session data (like what would come from LINE login)
                const mockSession = {
                    user: {
                        email: 'test@example.com',
                        name: 'John Doe'
                    }
                };
                
                const userEmail = mockSession.user.email;
                const userName = mockSession.user.name;
                const departmentName = 'IT';
                
                console.log('üîç Mock user data:', { userEmail, userName, departmentName });
                
                // Step 1: Try to get by email
                console.log('üîç Step 1: Getting by email...');
                const emailResponse = await fetch(`/api/resume-deposit?email=${encodeURIComponent(userEmail)}`);
                console.log('Email API status:', emailResponse.status);
                
                if (emailResponse.ok) {
                    const emailData = await emailResponse.json();
                    console.log('Email API data:', emailData);
                    const emailList = emailData?.data || emailData || [];
                    
                    if (emailList.length > 0) {
                        const found = emailList[0];
                        console.log('‚úÖ Found by email:', found);
                        
                        document.getElementById('result2').innerHTML = `
                            <h3>‚úÖ Found Resume Data by Email</h3>
                            <p><strong>ID:</strong> ${found.id}</p>
                            <p><strong>Name:</strong> ${found.firstName} ${found.lastName}</p>
                            <p><strong>Email:</strong> ${found.email}</p>
                            <p><strong>Department:</strong> ${departmentName} (from URL parameter)</p>
                            <pre>${JSON.stringify(found, null, 2)}</pre>
                        `;
                        return;
                    }
                }
                
                // Step 2: Try to get by name
                console.log('üîç Step 2: Getting by name...');
                const nameParts = userName.trim().split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                
                console.log('Name parts:', { firstName, lastName });
                
                const nameResponse = await fetch('/api/resume-deposit');
                if (nameResponse.ok) {
                    const nameData = await nameResponse.json();
                    const nameList = nameData?.data || nameData || [];
                    
                    console.log('All records:', nameList.length);
                    
                    const nameFiltered = nameList.filter((r) => {
                        const rFirstName = (r?.firstName || '').trim();
                        const rLastName = (r?.lastName || '').trim();
                        return rFirstName.toLowerCase() === firstName.toLowerCase() && 
                               rLastName.toLowerCase() === lastName.toLowerCase();
                    });
                    
                    console.log('Filtered by name:', nameFiltered.length);
                    
                    if (nameFiltered.length > 0) {
                        const found = nameFiltered[0];
                        console.log('‚úÖ Found by name:', found);
                        
                        document.getElementById('result2').innerHTML = `
                            <h3>‚úÖ Found Resume Data by Name</h3>
                            <p><strong>ID:</strong> ${found.id}</p>
                            <p><strong>Name:</strong> ${found.firstName} ${found.lastName}</p>
                            <p><strong>Email:</strong> ${found.email}</p>
                            <p><strong>Department:</strong> ${departmentName} (from URL parameter)</p>
                            <pre>${JSON.stringify(found, null, 2)}</pre>
                        `;
                        return;
                    }
                }
                
                // No data found
                document.getElementById('result2').innerHTML = `
                    <h3>‚ùå No Resume Data Found</h3>
                    <p>No resume data found for email: ${userEmail} or name: ${userName}</p>
                    <p>Department will be set to: ${departmentName}</p>
                `;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result2').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        async function testSpecificEmail() {
            try {
                const email = document.getElementById('testEmail').value;
                console.log('üîç Testing specific email:', email);
                
                const response = await fetch(`/api/resume-deposit?email=${encodeURIComponent(email)}`);
                const data = await response.json();
                
                console.log('Specific email response:', data);
                
                document.getElementById('result3').innerHTML = `
                    <h3>Email: ${email}</h3>
                    <p>Status: ${response.status}</p>
                    <p>Records found: ${data.data ? data.data.length : 0}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result3').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
